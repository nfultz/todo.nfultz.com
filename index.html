<head>
<title>Outline test</title>
<script>
outline = {
    "_": "level one",
    "items": [
        {"_":"level two"},
        {"_":"level two.sub",
        "items":[
            {"_":"level three"},
            {"_":"level three"},
        ]},
        {"_":"level two.2j"}
    ]}

var doubleLink = function(data){
    if(data.items)
    for(i of data.items){
        i.parent=data;
        doubleLink(i);
    }
}

var eraseChildren = function(node){
    while(node.firstChild) node.removeChild(node.firstChild)
}

doubleLink(outline)

current = 0

var render = function(data){
    current = data;
    renderTree(document.getElementById("main"), data)
    renderBreadcrumb(document.getElementById("breadcrumb"), data)
}

var deleteItem = function (data) {
  var a = data.parent.items
  var i = a.indexOf(data)

  data.parent.items = a.slice(0, i).concat(data.items || []).concat(a.slice(i+1))

}

var renderTree = function(node, data) {
    eraseChildren(node);

    //drilldown
    var popNode = document.createElement('a');
    popNode.textContent = data["_"]
    popNode.ondblclick = function(){render(data)}
    popNode.onclick = function(){popNode.setAttribute('contentEditable', 'true')}
    popNode.onblur = function(){
        popNode.setAttribute('contentEditable', 'false')
        var txt = popNode.textContent
        if(data.parent && !txt) {
            deleteItem(data)
            render(current)
        } else data['_'] = txt
    }
    node.appendChild(popNode);

    if(!data.items) return;

    //collapseToggle
    var collapseNode = document.createElement('a');
    collapseNode.textContent = data.collapsed ? "+" : "-"
    collapseNode.onclick = function() {
            data.collapsed = !data.collapsed;
            render(current)
        }
    node.insertBefore(collapseNode, node.firstChild)

    if(data.collapsed) {
        return
    }

    for(i of data.items){
        var childNode = document.createElement("div");
        node.appendChild(childNode)
        renderTree(childNode, i);
    }
}

var renderBreadcrumb = function(node, data){

    eraseChildren(node)

    while(data.parent) {
        data = data.parent

        var childNode = document.createElement('a')
        childNode.textContent = data['_']
        childNode.onclick = (function(i,f){
            return function(){render(i)}
        })(data)

        node.insertBefore(document.createTextNode('>'), node.firstChild)
        node.insertBefore(childNode, node.firstChild)

    }



}


</script>
<style>
div {margin-left: 1em}
a[contentEditable="true"] {background: #CCC}
</style>

</head>
<body>
    <div id=breadcrumb></div>
    <div id=main></div>
    <script>render(outline)</script>
</body>

