<html>
<head>
<title>Outline test</title>
<meta charset="UTF-8"/>
<script>

var doubleLink = function(data){
    if(data.items)
    for(i of data.items){
        i.parent=data;
        doubleLink(i);
    }
}

var eraseChildren = function(node){
    while(node.firstChild) node.removeChild(node.firstChild)
}


current = 0

var render = function(data){
    current = data;
    filtertxt = document.getElementsByName("filter")[0].value
    renderTree(document.getElementById("main"), data, filtertxt)
    renderBreadcrumb(document.getElementById("breadcrumb"), data)
}

var deleteItem = function (data) {
  if(!data.parent) return;
  var a = data.parent.items
  var i = a.indexOf(data)
  data.parent.items = a.slice(0, i).concat(data.items || []).concat(a.slice(i+1))
}

var indent = function(data){
  var a = data.parent.items
  var i = a.indexOf(data)

  if(i <= 0) return;
  a.splice(i,1)
  if(!a[i-1].items)
        a[i-1].items = []

  a[i-1].items.push(data)
  data.parent = a[i-1]

}

var dedent = function(data) {

  if(!data.parent || !data.parent.parent) return;
  var a = data.parent.items
  var i = a.indexOf(data)

  if(i < 0) return;
  
  if(!data.items)
        data.items = []
  data.items = data.items.concat(a.splice(i+1, 999))
  if(data.items.length == 0)
        delete data.items
  a.pop()

  if(a.length ==0)
    delete data.parent.items

  var b = data.parent.parent.items
  var j = b.indexOf(data.parent)

  b.splice(j+1,0,data)
  data.parent = data.parent.parent
  doubleLink(data)



}

var swapup = function(data){

  var a = data.parent.items
  var i = a.indexOf(data)

  if(i == 0) return;

  a[i] = a[i-1]
  a[i-1] = data

}

var swapdown = function(data){

  var a = data.parent.items
  var i = a.indexOf(data)

  if(i == a.length -1) return;
    
  a[i] = a[i+1]
  a[i+1] = data

}

insertup = function(data, txt) {

  var a = data.parent.items
  var i = a.indexOf(data)

  data.selected = false

  toAdd = {"_":txt, "selected":true, "parent":data.parent}
  a.splice(i,0,toAdd)

}

insertdown = function(data, txt) {

  data.selected = false
  toAdd = {"_":txt, "selected":true, "parent":data}

  if(!data.items) data.items = []
  data.items.unshift(toAdd)
}
 

var setSelected = function(idx, delta) {
    var leaves = document.getElementsByClassName("leaf")
    var selected = 0

    if(leaves.selected) {
        while(leaves.selected != leaves[selected]) selected++;
    }
    selected = ((delta ? selected + delta : idx) + leaves.length) % leaves.length
    setSelected2(leaves[selected])
}

var nextSelected = function(){
    setSelected(0, 1)
}

var prevSelected = function(){
    setSelected(0, -1)
}

var nextStatus = function(data){
    statuses = "+-âœ”"

    i = statuses.indexOf(data.status || '') + 1 + statuses.length
    data.status = statuses[i % statuses.length]
}

var setSelected2 = function(newNode) {
    var old = document.getElementById("selected")
    if(old) {
        old.setAttribute('id', null)
      if(old.data) old.data.selected = false
    }

    newNode.setAttribute("id", "selected")
    if(newNode.data) newNode.data.selected = true
}

var renderLeaf = function(node, txt){
    var chunks = txt.match(/[#@]\w+|[^#@]*/g)

    for(chunk of chunks){
        var txtNode = document.createTextNode(chunk)
        var childNode = document.createElement('a')
        switch(chunk[0]) {
                case '#':
                case '@':
                childNode.setAttribute('class', {'#':'hashtag', '@':'attag'}[chunk[0]])
                childNode.setAttribute('href', '#')
                childNode.appendChild(txtNode)
                childNode.onclick = (function(i){
                    return function(e){
                        e.stopPropagation()
                        document.getElementsByName("filter")[0].value = i
                        render(current)
                    }
                })(chunk)
                break;
                default:
                  childNode = txtNode
        }
        node.append(childNode)


    }

}

var renderTree = function(node, data, filtertxt) {
    eraseChildren(node);
    toDraw = !filtertxt || data["_"].search(filtertxt) >= 0
    if(!toDraw) data.selected = false

    //drilldown
    var popNode = document.createElement('span');
    popNode.setAttribute("class", "leaf")
    renderLeaf(popNode, data["_"])
    if(data.selected)
        popNode.setAttribute("id", "selected")
    popNode.data = data

    popNode.ondblclick = function(){render(data)}
    popNode.onclick = function(){
        setSelected2(popNode)
        popNode.setAttribute('contentEditable', 'true')
        popNode.focus()
    }
    popNode.onblur = function(){
        popNode.setAttribute('contentEditable', 'false')
        var txt = popNode.textContent
        if(!txt) {
            deleteItem(data)
            render(current)
        } else data['_'] = txt
    }
    if(toDraw) node.appendChild(popNode);

    if(!data.items) return;

    //collapseToggle
    var collapseNode = document.createElement('a');
    collapseNode.textContent = data.status || '-'
    collapseNode.setAttribute("class", "collapsed-" + (data.collapsed == true) )
    collapseNode.onclick = function() {
            setSelected2(popNode)
            data.collapsed = !data.collapsed;
            render(current)
        }
    if(toDraw) node.insertBefore(collapseNode, node.firstChild)

    if(data.collapsed && toDraw) {
        return
    }

    for(i of data.items){
        var childNode = document.createElement("div");
        node.appendChild(childNode)
        renderTree(childNode, i, filtertxt);
    }
}

var renderBreadcrumb = function(node, data){

    eraseChildren(node)

    while(data.parent) {
        data = data.parent

        var childNode = document.createElement('a')
        childNode.textContent = data['_']
        childNode.onclick = (function(i,f){
            return function(){render(i)}
        })(data)

        node.insertBefore(document.createTextNode(' > '), node.firstChild)
        node.insertBefore(childNode, node.firstChild)

    }



}


function keys(key) {
    var filter = document.getElementsByName('filter')[0]
    var selected = document.getElementById('selected')

    if(document.activeElement.name == 'filter' && key.which != 27){
        render(current)
        if(select == null && document.getElementsByClassName("leaf").length > 0) setSelected(0,0)
        return;
    }

    if(selected && selected.getAttribute('contentEditable') == 'true' && key.which != 27) return false;

	if (true) {
		switch (key.which) {
			case 8: // backspace
                if(current.parent)
                    render(current.parent);
                break;
			case 10: // return
			case 13: // enter
                selected.ondblclick()
                break;
            case 27: //escape
                if(selected.getAttribute('contentEditable') !='true') {
                    filter.value = ''
                }
                document.activeElement.blur()
                render(current)
                break;
			case 32: // spacebar
                selected.onclick()
                break;
			case 39: // rightkey
            case 76: //l
                if(key.shiftKey){
                    indent(selected.data);
                    render(current)
                    break;
                }
                if(selected.data.collapsed) {
                    selected.data.collapsed = false;
                    render(current)
                    break
                }
            case 74: //j
			case 40: // downkey
                if(key.shiftKey) {
                    swapdown(selected.data);
                    render(current)
                    break;
                }
                nextSelected()
				break;
			case 37: // leftkey
            case 72: // h
                if(key.shiftKey) {
                    dedent(selected.data);
                    render(current)
                    break;
                }
                if(selected.data.items && !selected.data.collapsed) {
                    selected.data.collapsed = true;
                    render(current)
                    break
                }
            case 75://k
			case 38: // upkey
                if(key.shiftKey) {
                    swapup(selected.data);
                    render(current)
                    break;
                }
               prevSelected()
			   break;
            case 191: //slash
                filter.focus()
                break;
            case 79: // o new item above / below
                if(key.shiftKey) {
                    insertup(selected.data, filter.value);
                    render(current)
                    document.getElementById('selected').click()
                    break;
                }
                insertdown(selected.data, filter.value);
                render(current)
                document.getElementById('selected').click()
                break
            case 83: // s
                nextStatus(selected.data);
                render(current)
                break;
            case 87 : // w for write
                download();
                break;
            case 90: // z
                selected.data.collapsed =!selected.data.collapsed;
                render(current)
                break;
            case 68: // d delete
                deleteItem(selected.data)
                render(current)
                break;
                
		}
   }
	return false;
}

window.onload = function(){
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
                       // Typical action to be performed when the document is ready:
                outline = JSON.parse(xhttp.responseText)
                doubleLink(outline)
                document.onkeyup = keys
                render(outline)
                setSelected(0,0)
        }
    };
    xhttp.open("GET", "outline.json", true);
    xhttp.send();
}

//from https://stackoverflow.com/a/18197341/986793
var download = function() {
      var tidy = function(obj){
          var out = { "_":obj["_"] }
          if(obj.status) out.status = obj.status
          if(obj.collapsed) out.collapsed = obj.collapsed
          if(obj.items) out.items = obj.items.map(tidy)
          return out;
      }

      var text = JSON.stringify(tidy(outline))
      var element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      element.setAttribute('download', 'outline.json');

      element.style.display = 'none';
      document.body.appendChild(element);

      element.click();

      document.body.removeChild(element);
}
</script>

<style>
div {margin-left: 1em}
span[contentEditable="true"] {background: #CCC}
#selected.leaf {border: 1px dotted}
.attag { color: green }
.hashtag { color: blue }
a.collapsed-true {color:orange}
a.collapsed-true, a.collapsed-false {margin-left: -1em; width: 1em; display:inline-block}
.wrap {margin-left:100px; margin-right:100px}
div.filter {text-align: right}
div#breadcrumb {float:left}
</style>

</head>
<body>
<div class=wrap>
    <header>Neal's work</header>
    <hr/>
    <div id=breadcrumb></div>
    <div class=filter><input name=filter></input></div>
    <hr/>
    <div id=main></div>
</div>
</body>

