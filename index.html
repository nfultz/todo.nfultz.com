<head>
<title>Outline test</title>
<script>
outline = {
    "_": "level one",
    "items": [
        {"_":"level two"},
        {"_":"level two.sub",
        "items":[
            {"_":"level three"},
            {"_":"level three"},
        ]},
        {"_":"level two.2j"}
    ]}

var doubleLink = function(data){
    if(data.items)
    for(i of data.items){
        i.parent=data;
        doubleLink(i);
    }
}

var eraseChildren = function(node){
    while(node.firstChild) node.removeChild(node.firstChild)
}

doubleLink(outline)

current = 0

var render = function(data){
    current = data;
    renderTree(document.getElementById("main"), data)
    renderBreadcrumb(document.getElementById("breadcrumb"), data)
}

var deleteItem = function (data) {
  var a = data.parent.items
  var i = a.indexOf(data)
  data.parent.items = a.slice(0, i).concat(data.items || []).concat(a.slice(i+1))
}

var setSelected = function(idx, delta) {
    var leaves = document.getElementsByClassName("leaf")
    var selected = 0
    //console.log("" + idx + " " + delta)
    //console.log(leaves)

    if(leaves.selected) {
        while(leaves.selected != leaves[selected]) selected++;
    }
    selected = ((delta ? selected + delta : idx) + leaves.length) % leaves.length
    setSelected2(leaves[selected])
}

var nextSelected = function(){
    setSelected(0, 1)
}

var prevSelected = function(){
    setSelected(0, -1)
}

var setSelected2 = function(newNode) {
    var old = document.getElementById("selected")
    if(old) {
        old.setAttribute('id', null)
      if(old.data) old.data.selected = false
    }

    newNode.setAttribute("id", "selected")
    if(newNode.data) newNode.data.selected = true
}

var renderTree = function(node, data) {
    eraseChildren(node);

    //drilldown
    var popNode = document.createElement('span');
    popNode.setAttribute("class", "leaf")
    popNode.innerHTML = data["_"]
    if(data.selected) 
        popNode.setAttribute("id", "selected")
    popNode.data = data

    popNode.ondblclick = function(){render(data)}
    popNode.onclick = function(){
        setSelected2(popNode)
        popNode.setAttribute('contentEditable', 'true')
    }
    popNode.onblur = function(){
        popNode.setAttribute('contentEditable', 'false')
        var txt = popNode.textContent
        if(data.parent && !txt) {
            deleteItem(data)
            render(current)
        } else data['_'] = txt
    }
    node.appendChild(popNode);

    if(!data.items) return;

    //collapseToggle
    var collapseNode = document.createElement('a');
    collapseNode.textContent = data.collapsed ? "+" : "-"
    collapseNode.onclick = function() {
            setSelected2(popNode)
            data.collapsed = !data.collapsed;
            render(current)
        }
    node.insertBefore(collapseNode, node.firstChild)

    if(data.collapsed) {
        return
    }

    for(i of data.items){
        var childNode = document.createElement("div");
        node.appendChild(childNode)
        renderTree(childNode, i);
    }
}

var renderBreadcrumb = function(node, data){

    eraseChildren(node)

    while(data.parent) {
        data = data.parent

        var childNode = document.createElement('a')
        childNode.textContent = data['_']
        childNode.onclick = (function(i,f){
            return function(){render(i)}
        })(data)

        node.insertBefore(document.createTextNode('>'), node.firstChild)
        node.insertBefore(childNode, node.firstChild)

    }



}


function keys(key) {
    var selected = document.getElementById('selected')
    if(selected.getAttribute('contentEditable') == 'true') return false;

	if (true) {
		switch (key.which) {
			case 10: // return
			case 13: // enter
                var event = new MouseEvent('dblclick', {
                        'view': window,
                        'bubbles': true,
                        'cancelable': true
                      });
                document.getElementById('selected').dispatchEvent(event);
                break;
			case 32: // spacebar
                var event = new MouseEvent('click', {
                        'view': window,
                        'bubbles': true,
                        'cancelable': true
                      });
                document.getElementById('selected').dispatchEvent(event);
                break;
			case 34: // page down
			case 39: // rightkey
                if(selected.data.collapsed) {
                    selected.data.collapsed = false;
                    render(current)
                    break
                }
			case 40: // downkey
                nextSelected()
				break;
			case 33: // page up
			case 37: // leftkey
                if(selected.data.items && !selected.data.collapsed) {
                    selected.data.collapsed = true;
                    render(current)
                    break
                }
			case 38: // upkey
                prevSelected()
			   break;
			case 36: // home
				goTo(0);
				break;
			case 35: // end
				goTo(smax-1);
				break;
			case 67: // c
				showHide('k');
				break;
			case 78: // n
				createNotesWindow();
				break;
		}
   }
	return false;
}

window.onload = function(){
  document.onkeyup = keys
  render(outline)
  setSelected(0,0)
}
</script>
<style>
div {margin-left: 1em}
span[contentEditable="true"] {background: #CCC}
#selected.leaf {border: 1px dotted}
</style>

</head>
<body>
    <header>Neal's work</header>
    <input name=filter></input>
    <hr/>
    <div id=breadcrumb></div>
    <hr/>
    <div id=main></div>
</body>

